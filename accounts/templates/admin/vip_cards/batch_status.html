{% extends "admin/base_site.html" %}
{% load i18n admin_urls static %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
    &rsaquo; <a href="{% url 'admin:app_list' app_label='accounts' %}">Accounts</a>
    &rsaquo; <a href="{% url 'admin:accounts_vipdigitalcard_changelist' %}">VIP Digital Cards</a>
    &rsaquo; {{ title }}
</div>
{% endblock %}

{% block content %}
<div class="module">
    <h2>Batch Status: {{ batch.batch_id }}</h2>

    <div class="batch-info">
        <div class="info-grid">
            <div class="info-item">
                <strong>Tier:</strong>
                <span class="tier-badge tier-{{ batch.tier }}">{{ batch.tier|upper }}</span>
            </div>
            <div class="info-item">
                <strong>Quantity:</strong> {{ batch.quantity }}
            </div>
            <div class="info-item">
                <strong>Status:</strong>
                <span class="status-badge status-{{ batch.status }}">{{ batch.status|title }}</span>
            </div>
            <div class="info-item">
                <strong>Generated By:</strong> {{ batch.generated_by.get_full_name|default:batch.generated_by.email }}
            </div>
            <div class="info-item">
                <strong>Generated Date:</strong> {{ batch.generated_date|date:"Y-m-d H:i" }}
            </div>
            <div class="info-item">
                <strong>Cards Generated:</strong> {{ cards.count }}/{{ batch.quantity }}
            </div>
        </div>

        {% if batch.notes %}
        <div class="notes-section">
            <strong>Notes:</strong>
            <p>{{ batch.notes }}</p>
        </div>
        {% endif %}
    </div>

    {% if cards %}
    <div class="cards-section">
        <h3>Generated Cards</h3>

        <div class="actions-bar">
            <a href="#" class="button" onclick="exportCards()">üìÑ Export CSV</a>
            <a href="#" class="button" onclick="printCards()">üñ®Ô∏è Print List</a>
            {% if batch.status == 'generated' %}
            <a href="#" class="button default" onclick="markAsDistributed()">‚úÖ Mark as Distributed</a>
            {% endif %}
        </div>

        <div class="results">
            <table class="card-table">
                <thead>
                    <tr>
                        <th>Serial Number</th>
                        <th>Activation Code</th>
                        <th>Status</th>
                        <th>Activated By</th>
                        <th>Activated Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for card in cards %}
                    <tr class="{% cycle 'row1' 'row2' %}">
                        <td>
                            <code>{{ card.serial_number }}</code>
                            {% if card.status == 'active' %}
                            <span class="active-indicator">‚úÖ</span>
                            {% endif %}
                        </td>
                        <td><code>{{ card.activation_code }}</code></td>
                        <td>
                            <span class="status-badge status-{{ card.status }}">{{ card.status|title }}</span>
                        </td>
                        <td>
                            {% if card.activated_by %}
                            <a href="{% url 'admin:accounts_user_change' card.activated_by.id %}" target="_blank">
                                {{ card.activated_by.get_full_name|default:card.activated_by.email }}
                            </a>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>
                            {% if card.activated_date %}
                            {{ card.activated_date|date:"Y-m-d H:i" }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'admin:accounts_vipdigitalcard_change' card.id %}" class="mini-button">‚úèÔ∏è
                                Edit</a>
                            {% if card.status == 'active' %}
                            <a href="#" class="mini-button danger" onclick="deactivateCard('{{ card.id }}')">üîí
                                Deactivate</a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <div class="submit-row">
        <a href="{% url 'admin:accounts_vipdigitalcard_changelist' %}" class="button">¬´ Back to Cards List</a>
        <a href="{% url 'admin:accounts_cardbatchgeneration_changelist' %}" class="button">View All Batches</a>
    </div>
</div>

<style>
    .batch-info {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 20px;
        margin-bottom: 30px;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .tier-badge,
    .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 3px;
        font-size: 12px;
        font-weight: bold;
        color: white;
    }

    .tier-vip {
        background-color: #FFD700;
        color: #000;
    }

    .tier-vip_premium {
        background-color: #9932CC;
    }

    .status-pending {
        background-color: #6c757d;
    }

    .status-generated {
        background-color: #28a745;
    }

    .status-distributed {
        background-color: #17a2b8;
    }

    .status-cancelled {
        background-color: #dc3545;
    }

    .status-inactive {
        background-color: #6c757d;
    }

    .status-active {
        background-color: #28a745;
    }

    .status-suspended {
        background-color: #ffc107;
        color: #000;
    }

    .notes-section {
        border-top: 1px solid #dee2e6;
        padding-top: 15px;
    }

    .cards-section {
        margin-top: 30px;
    }

    .actions-bar {
        margin-bottom: 15px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .card-table {
        width: 100%;
        border-collapse: collapse;
    }

    .card-table th,
    .card-table td {
        padding: 8px 12px;
        text-align: left;
        border-bottom: 1px solid #dee2e6;
    }

    .card-table th {
        background-color: #f8f9fa;
        font-weight: bold;
    }

    .card-table code {
        background: #f1f3f4;
        padding: 2px 4px;
        border-radius: 2px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
    }

    .active-indicator {
        margin-left: 5px;
        font-size: 14px;
    }

    .mini-button {
        display: inline-block;
        padding: 2px 6px;
        margin: 0 2px;
        font-size: 11px;
        text-decoration: none;
        border-radius: 2px;
        border: 1px solid #ccc;
        background: #f8f9fa;
        color: #495057;
    }

    .mini-button:hover {
        background: #e9ecef;
    }

    .mini-button.danger {
        background: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
    }

    .mini-button.danger:hover {
        background: #f5c6cb;
    }
</style>

<script>
    function exportCards() {
        // Create CSV content
        let csvContent = "Serial Number,Activation Code,Status,Activated By,Activated Date\n";

        document.querySelectorAll('.card-table tbody tr').forEach(row => {
            const cells = row.querySelectorAll('td');
            const serialNumber = cells[0].querySelector('code').textContent;
            const activationCode = cells[1].querySelector('code').textContent;
            const status = cells[2].textContent.trim();
            const activatedBy = cells[3].textContent.trim();
            const activatedDate = cells[4].textContent.trim();

            csvContent += `"${serialNumber}","${activationCode}","${status}","${activatedBy}","${activatedDate}"\n`;
        });

        // Download CSV
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `vip_cards_batch_{{ batch.batch_id }}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
    }

    function printCards() {
        window.print();
    }

    function markAsDistributed() {
        if (confirm('Mark this batch as distributed? This action cannot be undone.')) {
            // In a real implementation, this would make an AJAX request
            alert('Feature to be implemented: Mark batch as distributed');
        }
    }

    function deactivateCard(cardId) {
        if (confirm('Deactivate this card? The user\'s tier may be reverted.')) {
            // In a real implementation, this would make an AJAX request
            alert('Feature to be implemented: Deactivate card');
        }
    }
</script>
{% endblock %}