{% load i18n %}
<form method="post" action="{% url 'marketing:submit_contact' %}" class="form-styled space-y-4">
  {% csrf_token %}
  {{ form.as_p }}
  <div class="flex gap-3 items-center">
    <button id="contact-submit" class="px-4 py-2 rounded bg-brandBlue text-white hover:bg-brandBlueLight">Send</button>
    <div id="contact-status" class="text-sm text-gray-600"></div>
  </div>
</form>
<script>
(function(){
  const form = document.currentScript.previousElementSibling;
  const btn = document.getElementById('contact-submit');
  const statusEl = document.getElementById('contact-status');
  function styleForm(el){
    if(!el) return;
    var inputs = el.querySelectorAll('input, select, textarea');
    inputs.forEach(function(i){
      i.classList.add(
        'block','w-full','rounded','border','border-ash','bg-white',
        'px-3','py-2','focus:outline-none','focus:ring-2',
        'focus:ring-turquoise','focus:border-brandBlue'
      );
    });
    var labels = el.querySelectorAll('label');
    labels.forEach(function(l){ l.classList.add('block','text-sm','font-medium','text-gray-700','mb-1'); });
    var ps = el.querySelectorAll('p');
    ps.forEach(function(p){ p.classList.add('space-y-1'); });
  }
  styleForm(form);

  async function handleSubmit(ev){
    if (ev) ev.preventDefault();
    if (!btn) return;
    btn.disabled = true;
    btn.classList.add('opacity-60','cursor-not-allowed');
    statusEl.textContent = '{% trans "Sendingâ€¦" %}';
    statusEl.className = 'text-sm text-gray-600';
    try {
      const r = await postForm(form);
      const container = document.getElementById('contact-container');
      container.innerHTML = r.html;
      // Rebind if a new form was returned (errors)
      const newForm = container.querySelector('form');
      if (newForm){
        styleForm(newForm);
        const newBtn = newForm.querySelector('#contact-submit');
        const newStatus = newForm.querySelector('#contact-status');
        newForm.addEventListener('submit', handleSubmit);
        if (newBtn){ newBtn.addEventListener('click', handleSubmit); }
        if (newStatus){ newStatus.textContent = r.ok ? '{% trans "Message sent successfully." %}' : '{% trans "Please fix the errors and try again." %}'; }
      }
    } catch(e){
      statusEl.textContent = '{% trans "Network error. Please try again." %}';
      statusEl.className = 'text-sm text-red-600';
    } finally {
      if (btn){ btn.disabled = false; btn.classList.remove('opacity-60','cursor-not-allowed'); }
    }
  }
  form.addEventListener('submit', handleSubmit);
  if (btn){ btn.addEventListener('click', handleSubmit); }
})();
</script>
