{% extends 'marketing/base.html' %}
{% load i18n %}
{% block title %}{% trans "Pricing" %}{% endblock %}
{% block content %}
<div class="max-w-7xl mx-auto px-4 py-12">
  <h1 class="text-3xl font-bold mb-6">{% trans "Pricing Calculator" %}</h1>
  <script>
    // Set default tier from query string if present
    window.addEventListener('DOMContentLoaded', function(){
      const params = new URLSearchParams(window.location.search);
      const tierParam = params.get('tier');
      if (tierParam) {
        const sel = document.getElementById('tier');
        if (sel) sel.value = tierParam.toLowerCase();
      }
    });
  </script>
  <div class="grid md:grid-cols-2 gap-8">
    <div class="space-y-3">
      <label class="block">
        <span class="text-sm">{% trans "Tier" %}</span>
        <select id="tier" name="tier" class="w-full border rounded p-2">
          <option value="normal">{% trans "Normal" %}</option>
          <option value="premium">{% trans "Premium" %}</option>
          <option value="vip">{% trans "VIP" %}</option>
        </select>
      </label>
      <label class="block">
        <span class="text-sm">{% trans "Distance (km)" %}</span>
        <input id="distance" name="distance" type="number" value="10" min="1" class="w-full border rounded p-2" />
      </label>
            let debounceId;
            async function update(){
              try {
                const r = await getFragment('{% url 'marketing:pricing' %}', { tier: tier.value, distance: distance.value });
                if (r.ok){
                  target.innerHTML = '<h2 class="font-semibold mb-2'>{% trans "Estimate" %}</h2>' + r.html;
                } else {
                  target.innerHTML = '<div class="p-3 rounded bg-red-50 text-red-700">{% trans "Could not fetch estimate. Please try again." %}</div>';
                }
              } catch(e){
                target.innerHTML = '<div class="p-3 rounded bg-red-50 text-red-700">{% trans "Network error while calculating. Check your connection and retry." %}</div>';
              }
            }
      </label>
            distance.addEventListener('input', function(){
              if (debounceId) clearTimeout(debounceId);
              debounceId = setTimeout(update, 300);
            });
    <div id="pricing-result" class="border rounded p-6">
      <h2 class="font-semibold mb-2">{% trans "Estimate" %}</h2>
  {% include 'marketing/_pricing_result.html' %}
    </div>
  </div>
  <script>
    (function(){
      const tier = document.getElementById('tier');
      const distance = document.getElementById('distance');
      const btn = document.getElementById('calcBtn');
      const target = document.getElementById('pricing-result');
      async function update(){
        const r = await getFragment('{% url 'marketing:pricing' %}', { tier: tier.value, distance: distance.value });
        if (r.ok){ target.innerHTML = '<h2 class="font-semibold mb-2">{% trans "Estimate" %}</h2>' + r.html; }
      }
      btn.addEventListener('click', update);
      distance.addEventListener('input', function(){ clearTimeout(window.__p); window.__p = setTimeout(update, 300); });
      tier.addEventListener('change', update);
    })();
  </script>
</div>
{% endblock %}
